name: "Database Migration Push"

on:
    push:
        branches:
            - mia/fctl-395-make-db-migration-slack-notif-go-to

jobs:
    run-migra-diff:
        name: Run Migra Diff
        runs-on: ubuntu-20.04

        steps:
            - name: Set GITHUB_BRANCH environment variable
              run: |
                  if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
                      echo "GITHUB_BRANCH=${{ github.event.repository.default_branch }}" >> $GITHUB_ENV
                  else
                      ref="${{ github.event.ref }}"
                      echo "GITHUB_BRANCH=${ref:11}" >> $GITHUB_ENV
                  fi

            - name: Set Slack channel based on branch
              run: |
                  echo "SLACK_CHANNEL=alerts-${{ env.GITHUB_BRANCH }}" >> $GITHUB_ENV

            - name: Notify Slack
              if: success()
              shell: python3 {0}
              run: |
                  import os
                  print(os.environ["SLACK_CHANNEL"])
