# Deploy Docker images to AWS ECR
name: Push images

# Publish on update to master branch
# https://github.com/samuelmeuli/action-electron-builder for macOS building
on:
    push:
        branches: [eric/add-wf]
    workflow_dispatch:

jobs:
    build-desktop-app:
        name: Build-desktop-app
        runs-on: ${{ matrix.os }}

        # Platforms to build on/for
        strategy:
        matrix:
            os: [macos-10.14, ubuntu-20.04, windows-latest]

        steps:
            - name: Checkout Git repository
              uses: actions/checkout@v2
              with:
                persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
                token: ${{ secrets.GHA_PERSONAL_ACCESS_TOKEN }}
                submodules: recursive

            - name: Set up codesigning secrets
              uses: apple-actions/import-codesign-certs@v1
              with: 
                p12-file-base64: ${{ secrets.MACOS_SIGNING_CERTIFICATE }}
                p12-password: ${{ secrets.MACOS_SIGNING_CERTIFICATE_PASSWORD }}

            - name: Publish the client-application
              run:
                cd client-applications && cd desktop && ./publish.sh release

            - name: Notify Slack
                run: |
                curl -X POST \
                --data-urlencode "payload={\"channel\": \"#alerts\", \"username\": \"Fractal Bot\", \"text\": \"Client-apps pushed to prod!\", \"icon_emoji\": \":fractal:\"}" \
                https://hooks.slack.com/services/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
