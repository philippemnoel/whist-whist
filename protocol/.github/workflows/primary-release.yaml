name: Auto release primary branches (dev, staging, master)

on:
  push:
    branches:
      - dev
      - staging
      - master

jobs:
  trigger-release:
    runs-on: ubuntu-latest
    steps:
        # Do not run if latest commit contains "skip-ci" in its message
      - if: "!contains(github.event.head_commit.message, 'skip-ci')"
        # TODO switch this to GITHUB_TOKEN once workflow_dispatch supports GHA initiated dispatches
        # (currently it requires the dispatcher to be a user, so a personal access token must be used
        # here)

        # The workflow ID can be determined by running:
        # ```
        # curl -u "$TOKEN:" \
        #   -H "Accept: application/vnd.github.v3+json" \
        #   https://api.github.com/repos/fractalcomputers/protocol/actions/workflows
        # ```

        # NOTE: the root "ref" tag points to `master` because that is the version of the workflow that
        # we want to run (as in, that is the branch containing the specific YAML file that should be used)

        # TODO enable testing once it is working reliably

        # Pipe secrets.PROC_BRANCH_BUILD_RELEASE_ID to base64 so that the user can see it in the logs
        # since GHA auto redacts secrets.
        run: |
          echo "base64 encoded PROC_BRANCH_BUILD_RELEASE_ID (pipe to `base64 -d` to decode): "
          echo "${{ secrets.PROC_BRANCH_BUILD_RELEASE_ID }}" | base64
          curl -u "${{ secrets.CI_PAT }}:" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/fractalcomputers/protocol/actions/workflows/${{ secrets.PROC_BRANCH_BUILD_RELEASE_ID }}/dispatches \
            -d '{"ref": "master", "inputs": {"ref": "${{ github.ref }}", "should_test": "false"}}'
