version: "3.8"

x-app:
  &base-app
  build:
    context: ..
    dockerfile: docker/Dockerfile
  depends_on:
    - redis
  env_file: .env
  networks:
    - primary
  volumes:
    - ..:/app

services:

  redis:
    # Matches version being used by staging as of 2020-07-08
    image: redis:5.0.8
    ports:
      - "7810:6379" # Proxy redis on localhost:7810
    networks:
      - primary

  web:
    << : *base-app
    command: web
    ports:
      - "7730:7730" # Proxy 7730 (should match $PORT) on localhost
    environment:
      HOT_RELOAD: ${HOT_RELOAD}
      PORT: 7730

  celery:
    << : *base-app
    command: celery

# TODO use a local DB (as commented out below) instead of the staging/production DB
#   db:
#     image: postgres:9.4
#     volumes:
#       - db-data:/var/lib/postgresql/data
#     networks:
#       - primary
#
# volumes:
#   db-data:

networks:
  primary:
