# Dev Client for development/benchmarking purposes

The mandelbox from this folder runs the protocol client using a X server within Docker, and connects to a Whist portocol server (by default, on the same machine).

## Dev Client Docker container

The Docker container for the dev client is a lightweight mandelbox, created as follows. The Dockerfile for the dev client is based off the base mandelbox, with one notable modification: we replace the `whist-main.service` file in `/etc/systemd/system` with the one from this folder. The `development/client/whist-main.service` service file is mostly identical to its `base/main/whist-main.service` counterpart, with the exception of the script in the ExecStart field. The base/main version runs the `run-whist-server.sh` script (copied to `/usr/share/whist/` on the container from the `base/main` folder), whereas the `development/client/` version will run `run-whist-client.sh` (copied from this folder).

At startup, the execution flow on the Docker container will be:

1.  `base/startup/entrypoint.sh` is executed (as requested by the **CMD** instruction in `base/Dockerfile.20`), and it runs the `systemd` program.
2.  `systemd` will run the `base/startup/whist-startup.service` service, which calls `base/startup/whist-startup.sh` (through the ExecStart field)
3.  `base/startup/whist-startup.sh` will block until the `.ready` file is written into `/whist/resourceMappings`. In the case of normal mandelboxes (e.g. the Chrome mandelbox), this file is generated by the host service through a call to MarkReady in the SpinUpMandelbox function. In our case, we don't create a full mandelbox, so we will generate this file through the script that generates the docker container for the dev client.
4.  `systemd` runs the `base/display/whist-display.service` and `base/audio/whist-audio.service` services, both of which are needed in our container to be able to run SDL (which requires audio/video) from the client protocol
5.  `systemd` runs the `whist-main.service` from this folder (instead of the version from `base/main`), which calls `run-whist-client.sh` through the ExecStart field.

### Building/Spinning up the Docker container with the Dev Client

#### Building

Normally, building a Docker container for a dev mandelbox works as follows:

- A call to `./build.sh APP` builds the protocol server (WhistServer), copies into a folder which will be accessed by the docker container, then calls `helper_scripts/build_mandelbox_image.py`
- `helper_scripts/build_mandelbox_image.py` builds the APP mandelbox Docker container, after having built all the other containers that the APP mandelbox depends on

To build the Docker container for the dev client, we use the same scripts, but we need to modify `./build.sh APP` so that if we are building the client app, it builds and copies over the protocol client, rather than the protocol server.

###Naming
This section provides a brief overview on the difference between container name, container ID, mandelbox name and ID, etc...

- The AppName of the mandelbox will be: `fractal/development/client:current-build`.
  - The Docker image name consists of the AppName prefix: `fractal/development/client`
  - The Docker image suffix consists of the AppName suffix after the colon: `current-build`
  - The Docker image ID is generated automatically to uniquely identify the image
- The MandelBox ID: `mandelbox.GetID()`, as described in `host-service/mandelbox/types/types.go` is a random string that the webserver creates for each mandelbox.
- DockerID (container ID): provided by Docker at mandelbox creation time.
- Docker container name: it is formed by concatenating the mandelboxID (generated by SpinUpMandelBox) to the AppName (converted to use hyphens instead of characters such as "/" or ":")
