# Dev Client for development/benchmarking purposes
The mandelbox from this folder runs the protocol client using a X server within Docker, and connects to a Whist portocol server (by default, on the same machine).

## Dev Client Docker container
The Docker container for the dev client is a lightweight mandelbox, created as follows. The Dockerfile for the dev client is based off the base mandelbox, with one notable modification: we replace the `fractal-main.service` file in `/etc/systemd/system` with the one from this folder. The `development/client/fractal-main.service` service file is mostly identical to its `base/main/fractal-main.service` counterpart, with the exception of the script in the ExecStart field. The base/main version runs the `run-fractal-server.sh` script (copied to `/usr/share/fractal/` on the container from the `base/main` folder), whereas the `development/client/` version will run `run-fractal-client.sh` (copied from this folder).

At startup, the execution flow on the Docker container will be:

1.  `base/startup/entrypoint.sh` is executed (as requested by the **CMD** instruction in `base/Dockerfile.20`), and it runs the `systemd` program.
2. `systemd` will run the `base/startup/fractal-startup.service` service, which calls `base/startup/fractal-startup.sh` (through the ExecStart field)
3. `base/startup/fractal-startup.sh` will block until the `.ready` file is written into `/fractal/resourceMappings`. In the case of normal mandelboxes (e.g. the Chrome mandelbox), this file is generated by the host service through a call to MarkReady in the SpinUpMandelbox function. In our case, we don't create a full mandelbox, so we will generate this file through the script that generates the docker container for the dev client.
4. `systemd` runs the `base/display/fractal-display.service` and `base/audio/fractal-audio.service` services, both of which are needed in our container to be able to run SDL (which requires audio/video) from the client protocol 
5. `systemd` runs the `fractal-main.service` from this folder (instead of the version from `base/main`), which calls `run-fractal-client.sh` through the ExecStart field.

### Building/Spinning up the Docker container with the Dev Client

#### Building

Normally, building a Docker container for a dev mandelbox works as follows:
* A call to `./build.sh APP` builds the protocol server (FractalServer), copies into a folder which will be accessed by the docker container, then calls `helper_scripts/build_mandelbox_image.py`  
* `helper_scripts/build_mandelbox_image.py` builds the APP mandelbox Docker container, after having built all the other containers that the APP mandelbox depends on

To build the Docker container for the dev client, we will use the same scripts, but we need to modify `./build.sh APP` so that if we are building the client app, it builds and copies over the protocol client, rather than the protocol server.

#### Running

Normally, running a mandelbox entails the following flow: `./run.sh APP` → `helper_scripts/run_mandelbox_image.sh` → `helper_scripts/run_mandelbox_image.py`. `run_mandelbox_image.py` will send a HTTP request to the host-service, which in turn will create a `APP` mandelbox by calling `SpinUpMandelBox`

For the dev client container, we will use the same scripts, but we need to modify `run_mandelbox_image.py` so that, when we are trying to run the dev client, instead of sending a HTTP request to the json-transport endpoint on the host-service (which in turn calls SpinUpMandelBox), we simply execute the `spin_up_dev_client_container.sh` script from this folder. The `spin_up_dev_client_container.sh` script takes care of doing the following things (a subset of what SpinUpMandelBox does):

1. Download any necessary user configs onto the container
2. Apply port bindings/forwarding if needed
3. Pass config variables such as FRACTAL_AES_KEY, which will be saved to file by the startup/entrypoint.sh script, in order for the container to be able to access them later and exported them as environment variables by the `run-fractal-client.sh` script. These config variables will have to be passed as parameters to the FractalClient executable, which will run in non-root mode in the container (username = fractal).
4. Create the Docker container, and start it
5. Decrypt user configs within the docker container, if needed
6. Write the config.json file if we want to test JSON transport related features
7. Write the .ready file to trigger `base/startup/fractal-startup.sh`


