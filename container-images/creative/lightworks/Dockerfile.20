FROM fractal/base:current-build

# Force failure on non-zero exit code for commands with a pipe in them
SHELL ["/bin/bash", "-Eeuo", "pipefail", "-c"]

# Install Xenial (Ubuntu 16.04) security package explicitly, for compatibility
RUN echo "deb http://security.ubuntu.com/ubuntu xenial-security main" >> /etc/apt/sources.list

# Install Lightworks dependencies explicitly
RUN apt-get update && apt-get install --allow-downgrades --no-install-recommends -y \
	libldap-2.4-2 \
	libjack0 \
	libssl1.0.0 \
	wget \
    && apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Download Lightworks installer
# Note that this is NOT the latest version of Lightworks -- it is an older version which works on Ubuntu 20.04
# It would be ideal to get the latest version to work, but it may not be possible for some time
RUN wget https://downloads.lwks.com/v14-5/lightworks-14.5.0-amd64.deb -qO "lightworks.deb"

# Install Lightworks
RUN apt-get update && apt-get install --allow-downgrades --no-install-recommends -y \
	./lightworks.deb \
    && apt-get autoremove -y \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Create default config paths
RUN su - fractal -c "mkdir -p /home/fractal/Lightworks"

# Setup Fractal application symlink
RUN ln -sf /usr/bin/lightworks /usr/bin/fractal-application
