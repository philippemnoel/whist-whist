# Workflow to build Docker images for basic testing

name: Docker Image CI - Ubuntu 20.04

on:
  pull_request:
    branches: [ master, dev ]

jobs:
  docker-build-base-ubuntu20:
    runs-on: ubuntu-20.04

    steps:
      - name: Checkout Git repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo

      - name: Checkout setup-scripts repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
          repository: fractalcomputers/setup-scripts
          token: ${{ secrets.CI_PAT }} # `CI_PAT` is a secret that contains the fractal-github user Personal Access Token
          path: base/setup-scripts

      - name: Checkout protocol repository
        uses: actions/checkout@v2
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0 # otherwise, you will failed to push refs to dest repo
          repository: fractalcomputers/protocol
          token: ${{ secrets.CI_PAT }} # `CI_PAT` is a secret that contains the fractal-github user Personal Access Token
          path: base/protocol

      - name: Build the Fractal protocol
        run: cd base/protocol && cmake . && make -j

      - name: Build the Ubuntu 20.04 Base Image
        run: cd base && docker build . --file Dockerfile.20 --tag base-ubuntu20.04:$(date +%s)

      # TODO: Actually write tests for the base image and application images, integrated with protocol for streaming  
